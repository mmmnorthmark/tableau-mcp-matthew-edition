# Secure Asset Serving for MCP

## Overview

This document describes the secure asset serving implementation for the Tableau MCP Server. This feature enables web-based MCP clients (like Claude.ai, ChatGPT) to load images and visualizations generated by the server through signed URLs.

## Phase 1 Implementation (MVP)

Phase 1 implements the core security mechanism with signed URLs, local storage, and graceful error handling.

### Architecture

The implementation consists of three main components:

1. **AssetManager** (`src/services/AssetManager.ts`): Centralized service for storing assets and generating signed URLs
2. **Asset Routes** (`src/server/assetRoutes.ts`): HTTP endpoints for serving assets with signature validation
3. **Default Error Images** (`defaults/`): SVG files for expired/missing asset states

### Configuration

#### Enabling Asset Serving

Asset serving is **disabled by default** to avoid requiring additional configuration for basic MCP server usage.

- **`MCP_ASSET_STRATEGY`**: Controls asset serving behavior (default: `disabled`)
  - `disabled`: Asset serving is off, tools return inline base64 data
  - `local`: Assets stored on local filesystem with signed URLs (Phase 1)
  - `s3`: Assets stored in S3 bucket with signed URLs (Phase 2 - not yet implemented)

#### Required Variables (when `MCP_ASSET_STRATEGY ≠ disabled`)

- **`MCP_ASSET_SECRET_KEY`**: High-entropy string (minimum 32 characters recommended) used for HMAC-SHA256 signing
  - Example: `"your-high-entropy-secret-key-at-least-32-chars-long"`
  - **Security Note**: Keep this secret! If leaked, anyone can forge asset URLs.

- **`MCP_ASSET_CORS_ORIGINS`**: Comma-separated list of allowed origins for CORS
  - Example: `"https://claude.ai,https://chatgpt.com"`
  - This controls which web applications can load your assets

#### Optional Variables

- **`MCP_ASSET_STORAGE_PATH`**: Directory path for storing assets (default: `./assets`)
  - Only used when `MCP_ASSET_STRATEGY=local`
  - Must be writable by the process running the MCP server
  - Example: `"/var/mcp/assets"`

- **`MCP_ASSET_EXPIRATION_HOURS`**: Hours before a generated link expires (default: `24`)
  - Example: `"48"` for 2 days
  - Affects both URL expiration and browser cache headers

### Usage

#### Storing Assets (Tool Developer)

```typescript
import { AssetManager } from '../services/AssetManager.js';

// Create asset manager instance
const config = getConfig();
const assetManager = new AssetManager(config, server);

// Store an SVG
const svgData = Buffer.from('<svg>...</svg>', 'utf-8');
const { url, assetId } = await assetManager.store(svgData, 'svg', {
  imageFilename: 'my-chart.svg'  // Optional: sets Content-Disposition header
});

// Return the URL in your tool response
return {
  isError: false,
  content: [{
    type: 'text',
    text: `![Visualization](${url})`
  }]
};
```

#### Supported File Extensions

- `.svg` - SVG images
- `.png` - PNG images
- `.jpg` - JPEG images

### Security Features

#### 1. Path Traversal Prevention

Asset IDs are validated against a strict regex pattern:
```regex
^[a-f0-9-]+\.(svg|png|jpg)$
```

This prevents attacks like:
- `../../../etc/passwd`
- `./config.json`
- `test;rm -rf /`

#### 2. HMAC-SHA256 Signatures

Each URL contains three query parameters:
- `assetId`: UUID-based unique identifier with file extension (e.g., `550e8400-e29b-41d4-a716-446655440000.svg`)
- `expires`: Unix timestamp (seconds) when the URL expires
- `sig`: URL-safe base64-encoded HMAC-SHA256 signature

**Signature Algorithm:**

The signature covers: `assetId + expires + secret`

```
message = assetId + ":" + expires + ":" + secret
signature = HMAC-SHA256(message, key=secret)
encoded_signature = base64url(signature)
```

Example:
```
assetId = "550e8400-e29b-41d4-a716-446655440000.svg"
expires = 1704844800
secret = "your-secret-key"
message = "550e8400-e29b-41d4-a716-446655440000.svg:1704844800:your-secret-key"
sig = HMAC-SHA256(message, key=secret) → base64url encoded
```

The signature is validated on every request using timing-safe comparison to prevent timing attacks.

#### 3. Expiration

- Links automatically expire after `MCP_ASSET_EXPIRATION_HOURS`
- Expired requests are redirected to `vizImageExpired.svg`
- Browser caching is set to remaining TTL to prevent stale content

#### 4. CORS Protection

Asset endpoints enforce strict CORS based on `MCP_ASSET_CORS_ORIGINS`:
- Only specified origins can fetch assets
- Credentials are disabled for security
- Only GET requests are allowed

### Error Handling

#### HTTP Status Codes

The asset endpoint uses clear, specific status codes:

1. **410 Gone**: Asset URL has expired
   - Redirects to `/defaults/vizImageExpired.svg`
   - Shows "Snapshot Expired" message
   - Indicates the timestamp has passed

2. **403 Forbidden**: Invalid signature or malformed request
   - Redirects to `/defaults/vizImageNotFound.svg`
   - Shows generic error message
   - Triggered by invalid signature, missing parameters, or path traversal attempts

3. **404 Not Found**: Valid signature but asset doesn't exist in storage
   - Redirects to `/defaults/vizImageNotFound.svg`
   - Shows "Asset Not Found" message
   - File was deleted or never created

4. **200 OK**: Successful asset retrieval
   - Returns asset data with appropriate MIME type
   - Includes `Cache-Control` headers based on remaining TTL

#### Logging

All key events are logged with appropriate levels:

- **INFO**: Successful asset storage and retrieval
  ```
  [AssetManager] Stored asset: 550e8400-e29b-41d4-a716-446655440000.svg
  [AssetEndpoint] Successfully served asset: 550e8400-e29b-41d4-a716-446655440000.svg
  ```

- **WARN**: Security violations
  ```
  [AssetManager] Expired access attempt for asset: 550e8400-e29b-41d4-a716-446655440000.svg
  [AssetManager] Invalid signature attempt for asset: 550e8400-e29b-41d4-a716-446655440000.svg
  [AssetEndpoint] Invalid assetId format: ../etc/passwd
  ```

- **ERROR**: Storage failures
  ```
  [AssetEndpoint] Asset not found: 550e8400-e29b-41d4-a716-446655440000.svg
  [AssetEndpoint] Error serving asset: [error details]
  ```

### Endpoints

#### `GET /mcp/assets`

Serves signed assets with validation.

**Query Parameters:**
- `assetId` (required): Asset identifier with extension
- `expires` (required): Unix timestamp in seconds
- `sig` (required): HMAC-SHA256 signature

**Response:**
- **200 OK**: Asset data with appropriate MIME type
- **302 Found**: Redirect to error SVG (expired or not found)

**Headers (on success):**
- `Content-Type`: Based on file extension (`image/svg+xml`, `image/png`, `image/jpeg`)
- `Content-Disposition`: `inline; filename="{sanitized_filename}"` (if metadata provided)
- `Cache-Control`: `public, max-age={remaining_ttl}`

#### `GET /defaults/:filename`

Serves default error SVG files.

**Parameters:**
- `filename`: Must be `vizImageExpired.svg` or `vizImageNotFound.svg`

**Response:**
- **200 OK**: SVG content
- **404 Not Found**: Invalid filename

### Example Configurations

#### Disabled (Default)

```bash
# Asset serving disabled - tools return base64 data inline
MCP_ASSET_STRATEGY=disabled
```

#### Enabled with Local Storage

```bash
# Enable asset serving with local filesystem storage
MCP_ASSET_STRATEGY=local
MCP_ASSET_SECRET_KEY=super-secret-key-with-at-least-32-chars
MCP_ASSET_CORS_ORIGINS=https://claude.ai,https://chatgpt.com
MCP_ASSET_STORAGE_PATH=./assets
MCP_ASSET_EXPIRATION_HOURS=24
```

#### Full MCP Server Configuration Example

```json
{
  "mcpServers": {
    "tableau": {
      "command": "node",
      "args": ["build/index.js"],
      "env": {
        "SERVER": "https://tableau.example.com",
        "TRANSPORT": "http",
        "PORT": "3927",
        "AUTH": "pat",
        "PAT_NAME": "my-pat",
        "PAT_VALUE": "secret-pat-value",
        "CORS_ORIGIN_CONFIG": "[\"https://claude.ai\"]",
        "MCP_ASSET_STRATEGY": "local",
        "MCP_ASSET_SECRET_KEY": "super-secret-key-with-at-least-32-chars",
        "MCP_ASSET_CORS_ORIGINS": "https://claude.ai,https://chatgpt.com",
        "MCP_ASSET_STORAGE_PATH": "./assets",
        "MCP_ASSET_EXPIRATION_HOURS": "24"
      }
    }
  }
}
```

### Testing

Comprehensive tests are available in `src/services/AssetManager.test.ts`.

Run tests with:
```bash
npm test -- src/services/AssetManager.test.ts
```

Test coverage includes:
- Asset storage and retrieval
- Signature generation and validation
- Path traversal prevention
- Filename sanitization
- Metadata handling
- Expiration logic

## Future Enhancements

### Phase 2: Administrator Flexibility
- S3 storage backend support
- Custom error images
- Configurable storage providers

### Phase 3: Advanced User Experience
- Metadata sidecar files with recreation parameters
- Dynamic error SVGs with actionable links
- Interactive error recovery

## Security Considerations

### Secret Key Rotation

If `MCP_ASSET_SECRET_KEY` is changed:
- All previously generated URLs will immediately become invalid
- Users will see expired image messages for old links
- This is acceptable for MVP but should be documented

### CORS Configuration

**Critical**: If `MCP_ASSET_CORS_ORIGINS` is not configured correctly:
- Assets will fail to load in browsers (CORS errors)
- Users will see broken images
- Browser console will show: `Access to fetch at '...' from origin '...' has been blocked by CORS policy`

### Browser Caching

- Valid assets are cached by browsers based on remaining TTL
- Expired assets receive `302` redirects, which are not cached
- Error SVGs are cached for 24 hours to reduce server load

## Troubleshooting

### Assets Not Loading

1. **Check CORS configuration**
   ```bash
   # Verify MCP_ASSET_CORS_ORIGINS matches the client origin
   echo $MCP_ASSET_CORS_ORIGINS
   ```

2. **Check browser console for errors**
   - CORS errors indicate origin mismatch
   - 404 errors indicate asset not found
   - Signature errors indicate invalid/expired URLs

3. **Verify storage directory permissions**
   ```bash
   # Ensure directory is writable
   ls -la ./assets
   ```

### All Links Showing as Expired

1. **Check server time synchronization**
   ```bash
   # Verify server clock is accurate
   date -u
   ```

2. **Verify MCP_ASSET_SECRET_KEY hasn't changed**
   - Changing the key invalidates all existing URLs

### Assets Returning 404

1. **Check storage path**
   ```bash
   # Verify files exist in configured path
   ls -la $MCP_ASSET_STORAGE_PATH
   ```

2. **Check file permissions**
   ```bash
   # Ensure files are readable
   chmod -R 644 ./assets/*.svg
   ```

## Migration Guide

### Updating Existing Tools

To migrate a tool from inline base64 images to signed URLs:

**Before:**
```typescript
const base64Data = Buffer.from(svgString).toString('base64');
return {
  isError: false,
  content: [{
    type: 'image',
    data: base64Data,
    mimeType: 'image/svg+xml'
  }]
};
```

**After:**
```typescript
const assetManager = new AssetManager(config, server);
const { url } = await assetManager.store(
  Buffer.from(svgString, 'utf-8'),
  'svg',
  { imageFilename: 'visualization.svg' }
);

return {
  isError: false,
  content: [{
    type: 'text',
    text: `![Visualization](${url})`
  }]
};
```

## Reference Implementation

The `render-pulse-svg` tool in `src/tools/pulse/renderPulseSvg/renderPulseSvg.ts` serves as a reference implementation demonstrating:
- AssetManager initialization
- Asset storage with metadata
- URL generation and return
- Integration with existing tool patterns
